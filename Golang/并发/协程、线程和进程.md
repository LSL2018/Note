# goroutine和系统级线程

- 系统级线程
  - 有一个固定大小的栈（一般默认可能是 2MB）
  - 栈主要用来保存函数递归调用时参数和局部变量
  - 固定了栈的大小导致了两个问题：一是对于很多只需要很小的栈空间的线程来说是一个巨大的浪费，二是对于少数需要巨大栈空间的线程来说又面临栈溢出的风险。
- goroutine
  - 以一个很小的栈启动（可能是 2KB 或 4KB），栈空间不足时会动态地伸缩栈的大小（主流实现中栈的最大值可达到1GB）
  - 可以在 n 个系统线程上调度 m 个 Goroutine
  - 采用的是半抢占式的协作调度，只有在当前 Goroutine 发生阻塞时才会导致调度
  - 发生在用户态，调度器会根据具体函数只保存必要的寄存器
  - 有一个 runtime.GOMAXPROCS 变量，用于控制当前运行正常非阻塞 Goroutine 的系统线程数目
  - 因为启动的代价很小，所以可以轻易地启动成千上万个 Goroutine